{{- $ctx := . -}}
{{- $curPage := .Page -}}
{{- $self_close := eq ( .Params.emptyElementStyle | default .Site.Params.emptyElementStyle ) "self-close" -}}

{{- $socials_rules := slice -}}
{{- with (partialCached "helpers/socials/get-enabled-services.html" "dananke/socials/get") -}}
    {{- range $service := . -}}
        {{- with .color -}}
            {{- $rule := printf `
                .dananke-socials a.%s:hover {
                    color: %s;
                }` $service.name $service.color -}}
            {{- $socials_rules = $socials_rules | append $rule -}}
        {{- end -}}
    {{- end -}}
    {{- with $socials_rules -}}
        {{- $socials_rules = delimit . "" -}}
    {{- end -}}
{{- end -}}

{{- $cssTemplate := resources.Get "/dananke/css-templates/base-vars.scss" -}}
{{- $combinedTemplate := printf "%s\n%s" $cssTemplate.Content $socials_rules -}}
{{- $cssTemplate := resources.Get "/dananke/css-templates/import.scss" -}}
{{- $combinedTemplate := printf "%s\n%s" $combinedTemplate $cssTemplate.Content -}}

{{- $customImports := (slice) -}}
{{- range site.Params.custom_css -}}
    {{- with resources.Get . -}}
        {{- $customImport := printf `
            @import '%s';
        ` .Name -}}
        {{- $customImports = $customImports | append $customImport -}}
    {{- end -}}
{{- end -}}
{{- with $customImports -}}
    {{- $customImports = delimit . "" -}}
    {{- $combinedTemplate = printf "%s\n%s" $combinedTemplate $customImports -}}
{{- end -}}

{{- $customImports = (slice) -}}
{{- $customCSS := resources.Match "/css/custom/*.css" -}}
{{- range $customCSS -}}
    {{- $customImport := printf `
        @import '%s';
    ` .Name -}}
    {{- $customImports := $customImports | append $customImport -}}
{{- end -}}

{{- with $customImports -}}
    {{- $customImports = delimit . "" -}}
    {{- $combinedTemplate = printf "%s\n%s" $combinedTemplate $customImports -}}
{{- end -}}

{{- $style := dict -}}
{{- with $combinedTemplate -}}
    {{- $style = . | resources.FromString "/dananke/css/string.scss" -}}
    {{- with $style -}}
        {{- $style = . | resources.ExecuteAsTemplate "/dananke/css/main.scss" $curPage -}}
    {{- end -}}
{{- end -}}

{{- with $style -}}
    {{- /* We then use toCSS to add sourceMap and minify (in production) */ -}}
    {{- $options := dict "targetPath" "css/dananke/main.css" "enableSourceMap" true "precision" 6 -}}
    {{- if hugo.IsProduction -}}
        {{- $options = $options | merge (dict "outputStyle" "compressed") -}}
    {{- else -}}
        {{- $options = $options | merge (dict "outputStyle" "expanded") -}}
    {{- end -}}
    {{- /* Actually process the CSS */ -}}
    {{- $style = . | resources.ToCSS $options -}}
    {{- /* We fingerprint in production for cache busting purposes */ -}}
    {{- if hugo.IsProduction -}}
        {{- $style = $style | fingerprint -}}
    {{- end -}}
{{- end -}}

{{- with $style }}
    <link rel="stylesheet" href="{{ .RelPermalink }}"{{ if $self_close }} /{{ end }}>
{{- end -}}
